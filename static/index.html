<html>
<head>
<title>
Simple billing application
</title>
<script type="text/javascript" src="jquery-1.3.2.js"></script>
<script type="text/javascript" src="date.js"></script>
<!--[if IE]><script type="text/javascript" src="jquery.bgiframe.js"></script><![endif]-->
<script type="text/javascript" src="jquery.datePicker.js"></script>

<link rel="stylesheet" type="text/css" media="screen" href="datePicker.css">
<script language="javascript">
<!--
function toggle_visible(name) {
  $("#" + name).toggle();
}
function add_user_submit() {
  full_name=$("#add_user_full_name").get(0).value;
  username=$("#add_user_username").get(0).value;
  function err (msg) {
    $("#add_user_error").text(msg);
  };
  if (full_name == "") {
    err("Need a full name for the new user");
    return;
  }
  if (username == "") {
    err("Need a username for the new user");
    return;
  }
  err("Creating a new user " + username + " for " + full_name);
  jQuery.post("action/add_user",
              {"username": username, "full_name": full_name},
     function(data) {
       if (data.result == "okay") {
         err("Created a new user " + username + " for " + full_name);
	 get_known_users();
       } else {
         err("Creating a new user " + username + " for " + full_name + ": " + data.error);
       }
     }, "json"
  );
}

function add_bill_submit() {
  var description = $("#add_bill_description").get(0).value;
  var amount = $("#add_bill_amount").get(0).value;
  var date = $("#add_bill_date").get(0).value;
  var who_pays = $("input[name='add_bill_who']:checked").val();
  var pay_whom = $("input[name='add_bill_whom']:checked").val();

  var eqlist_users;
  var to_pay;

  function err(msg) {
    $("#add_bill_error").text(msg);
  }
  err("");

  amount = parseFloat(amount);
  if (isNaN(amount) || amount < 0 || !isFinite(amount)) {
    err("Don't understand the given amount");
    return;
  }
  if (who_pays == "eqlist") {
    eqlist_users = []
    var q = $("input[class='add_bill_split_eq_item']:checked").get();
    for (k in q)
      eqlist_users.push(q[k].value);
    if (eqlist_users == []) {
      err("Need to select at least one user to split between");
      return;
    }
  }
  if (who_pays == "everyone") {
    if (typeof(known_users) == "undefined") {
      err("still waiting for list of users...");
      return;
    }
    who_pays = "eqlist";
    eqlist_users = []
    for (k in known_users)
      eqlist_users.push([known_users[k].uname]);
  }
  to_pay = []
  if (who_pays == "custom") {
    var q = $("input[class='add_bill_split_custom_item']").get();
    var tot = 0;
    for (k in q) {
      k2 = q[k];
      uname = k2.id.substring(22);
      cost = k2.value;
      if (cost == "")
        continue;
      cost2 = parseFloat(cost);
      if (isNaN(cost2) || cost2 < 0 || !isFinite(cost2)) {
        err("Don't understand " + cost + " as a cost");
	return;
      }
      tot += cost2;
      to_pay.push( {"user": uname, "charge": cost2 });
    }
    if (tot <= amount - 0.01 || tot >= amount + 0.01) {
      err("Costs don't add up (got " + tot + ", expected " + amount + ")");
      return;
    }
  }
  if (who_pays == "eqlist") {
    var amt_to_pay = amount / eqlist_users.length;
    for (u in eqlist_users) {
      to_pay.push( {"user": eqlist_users[u],
                    "charge": amt_to_pay} );
    }
    who_pays = "custom";
  }

  if (who_pays != "custom") {
    err("got very confused...");
    return;
  }

  var to_receive;
  if (pay_whom == "one") {
    var uname = $("input[name='add_bill_split_whom_one']:checked").val();
    to_receive = [ {"user": uname, "charge": amount } ]
  } else {
    var q = $("input[class='add_bill_split_whom_custom_item']").get();    
    var tot = 0;
    to_receive = []
    for (k in q) {
      var k2 = q[k];
      uname = k2.id.substring(27);
      cost = k2.value;
      if (cost == "")
        continue;
      cost2 = parseFloat(cost);
      if (isNaN(cost2) || cost2 < 0 || !isFinite(cost2)) {
        err("Don't understand " + cost + " as a receipt");
	return;
      }
      tot += cost2;
      to_receive.push( {"user": uname, "charge": cost2 });
    }
    if (tot <= amount - 0.01 || tot >= amount + 0.01) {
      err("Receipts don't add up (got " + tot + ", expected " + amount + ")");
      return;
    }  
  }

  function encode_json(what) {
    function encode_pair(w) {
      return "{ \"user\": \"" + encodeURIComponent(w["user"]) + "\", \"charge\": \"" + encodeURIComponent(w["charge"]) + "\"}";
    }
    var r = "[";
    for (i = 0; i < what.length - 1; i++) {
      r += encode_pair(what[i]);
      r += ",";
    }
    r += encode_pair(what[i]);
    r += "]";
    return r;
  }

  to_pay = encode_json(to_pay);
  to_receive = encode_json(to_receive);

  err("Adding bill");
  jQuery.post("action/add_bill",
              {"description": description,
	       "date": date,
	       "to_pay": to_pay,
	       "to_receive": to_receive},
	      function(data) {
	        if (data.result == "okay") {
		  err("Added bill " + description);
		  reset_add_bill();
		} else {
		  err("Adding bill " + description + ": " + data.error);
		}
	      }, "json");
}

-->
</script>
<body>

<ul>
  <li> <a onclick="toggle_visible(&quot;bills&quot;)"> Add bill </a>
    <div class="visible" id="bills">
      <form id="add_bill_form">
	<ul>
	  <li> Description: <input type="text" id="add_bill_description"> </li>
	  <li> Amount: <input type="text" id="add_bill_amount"> </li>
	  <li> Date: <input id="add_bill_date" class="date-pick" class="date-pick"/> </li>
	  <li> Who pays:<br>
	    <input type="radio" id="add_bill_who_everyone" name="add_bill_who" onclick="add_bill_who_everyone_sel()" checked value="everyone"> Everyone equally<br>
	    <input type="radio" id="add_bill_who_eqlist" name="add_bill_who" onclick="add_bill_who_eqlist_sel()" value="eqlist"> Split evenly between some people<br>
	    <div id="add_bill_who_eqlist_split">
	      Waiting for list of users...
	    </div>
	    <script>
	      <!--
		  $("#add_bill_who_eqlist_split").hide();
		-->
	    </script>
	    <input type="radio" id="add_bill_who_custom" name="add_bill_who" onclick="add_bill_who_custom_sel()" value="custom"> Manually specify split<br>
	    <div id="add_bill_who_custom_split">
	      Waiting for list of users...
	    </div>
	    <script>
	      <!--
		  $("#add_bill_who_custom_split").hide();
		-->
	    </script>
	  <li> Who gets reimbursed:<br>
	    <input type="radio" id="add_bill_whom_one" name="add_bill_whom" checked onclick="add_bill_whom_one_sel()" value="one"> One person <br>
	    <div id="add_bill_whom_one_split">
	      Waiting for list of users...
	    </div>
	    <input type="radio" id="add_bill_whom_custom" name="add_bill_whom" onclick="add_bill_whom_custom_sel()" value="custom"> Manually specify split<br>
	    <div id="add_bill_whom_custom_split">
	      Waiting for list of users...
	    </div>
	    <script>
	      <!--
		  $("#add_bill_whom_custom_split").hide();
		-->
	    </script>
	  </li>
	</ul>
	<input type="button" onclick="add_bill_submit()" value="Add bill">
	<div id="add_bill_error"></div>
      </form>
    </div>
  </li>
  <li> <a onclick="toggle_visible(&quot;old_bills&quot;)">Old bills</a>
    <div id="old_bills"></div>
  </li>
  <li> <a onclick="toggle_visible(&quot;user_management&quot;)"> User management </a>
  <div id="user_management">
    <p>
    Known users: <div id="known_user_list"> Loading... </div>
    </p>

    <ul>
      <li> <a onclick="script:toggle_visible(&quot;div:add_user&quot;)"> Add user </a>
	<div id="add_user">
	  <form>
	    <ul>
	      <li> Full name: <input type="text" name="fullname" alt="Full name" id="add_user_full_name"></li>
	      <li> Username: <input type="text" name="username" alt="User name" id="add_user_username"></li>
	    </ul>
	    <input type="button" onclick="add_user_submit()" value="Add user">
	    <div id="add_user_error"></div>
	  </form>
	</div>
      </li>
    </ul>
  </div>
  <script>
    <!--
	$("#user_management").hide();
      -->
  </script>
  </li>
</ul>

</p>
</body>
<script language="javascript">
<!--
function refresh_known_users() {
  var newContents = "<table>"
  for (var k in known_users) {
    newContents += "<tr>";
    newContents += "<td>" + known_users[k].uname + "</td>";
    newContents += "<td>" + known_users[k].fullname + "</td>";
    newContents += "<td><a onclick=\"remove_user(&quot;" + known_users[k].uname + "&quot;)\">Remove</a></td>";
    newContents += "<td id=\"remove_user_" + known_users[k].uname + "_error\"></td>"
    newContents += "</tr>";
  }
  newContents += "</table>";
  $("#known_user_list").html(newContents);
}
function refresh_bill_split() {
  var newContents = "<ul>";
  for (var k in known_users) {
    var uname = known_users[k].uname;
    var fullname = known_users[k].fullname;
    newContents += "<li><input type=\"checkbox\" class=\"add_bill_split_eq_item\" id=\"add_bill_split_eq_" + uname + "\" value=\"" + uname + "\">" + fullname + "</li>";
  }
  newContents += "</ul>";
  $("#add_bill_who_eqlist_split").html(newContents);

  newContents = "<ul>";
  for (var k in known_users) {
    var uname = known_users[k].uname;
    var fullname = known_users[k].fullname;
    newContents += "<li>" + fullname + "<input type=\"text\" id=\"add_bill_split_custom_" + uname + "\" class=\"add_bill_split_custom_item\"></li>";
  }
  newContents += "</ul>";
  $("#add_bill_who_custom_split").html(newContents);

  newContents = "<ul>";
  for (var k in known_users) {
    var uname = known_users[k].uname;
    var fullname = known_users[k].fullname;
    newContents += "<li><input type=\"radio\" name=\"add_bill_split_whom_one\" id=\"add_bill_split_whom_one_" + uname + "\" value=\"" + uname + "\">" + fullname + "</li>";
  }
  newContents += "</ul>";
  $("#add_bill_whom_one_split").html(newContents);

  newContents = "<ul>";
  for (var k in known_users) {
    var uname = known_users[k].uname;
    var fullname = known_users[k].fullname;
    newContents += "<li>" + fullname + "<input type=\"text\" id=\"add_bill_split_whom_custom_" + uname + "\" class=\"add_bill_split_whom_custom_item\"></li>";
  }
  newContents += "</ul>";
  $("#add_bill_whom_custom_split").html(newContents);
}
function get_known_users() {
  jQuery.getJSON("action/get_user_list", {},
    function(data, textStatus) {
      if (data.result == "okay") {
        known_users = data.data;
	refresh_known_users();
	refresh_bill_split();
      } else {
        $("#known_user_list").text("Error " + data.error + " getting user list");
      }
    }
  );
}
function remove_user(name) {
  function err(msg) {
    n = "#remove_user_" + name + "_error";
    $(n).text(msg);
  }
  err("Removing...");
  jQuery.post("action/remove_user",
              {"username": name},
	      function(data) {
	        if (data.result == "okay") {
		   err("removed");
		   get_known_users();
		} else {
		   err("Error: " + data.error);
		}
              }, "json");
}
get_known_users();

$(function()
{
  $('#add_bill_date').datePicker({startDate:'01/01/1996'});
});


function add_bill_who_eqlist_sel() {
$("#add_bill_who_eqlist_split").show();
$("#add_bill_who_custom_split").hide();
};
function add_bill_who_everyone_sel() {
$("#add_bill_who_eqlist_split").hide();
$("#add_bill_who_custom_split").hide();
};
function add_bill_who_custom_sel() {
$("#add_bill_who_eqlist_split").hide();
$("#add_bill_who_custom_split").show();
};

function add_bill_whom_one_sel() {
$("#add_bill_whom_one_split").show();
$("#add_bill_whom_custom_split").hide();
};
function add_bill_whom_custom_sel() {
$("#add_bill_whom_one_split").hide();
$("#add_bill_whom_custom_split").show();
};
function reset_add_bill() {
$("#add_bill_form")[0].reset();
};

function refresh_old_bills() {
  var new_contents = "<table>";
  for (var b in old_bills) {
    var bi = old_bills[b];
    function ident(c) {
      return "old_bill_" + bi.ident + "_" + c;
    }
    function show_charge(c) {
      return "<td><div id=\"" + ident("fullname") +"_" + c.ident + "\" class=\"old_bill_fullname\">" + c.fullname + "</div></td><td><div id=\"" + ident("charge") + "_" + c.ident + "\" class=\"old_bill_charge\">" + c.charge + "</div></td>";
    }
    new_contents += "<tr>";
    new_contents += "<td><div id=\"" + ident("date") + "\" class=\"old_bill_date\">" + bi.date + "</div></td>";
    new_contents += "<td><div id=\"" + ident("description") + "\" class=\"old_bill_description\">" + bi.description + "</div></td>";
    var c = bi.charges;
    new_contents += show_charge(c[0]) + "<td onclick=\"edit_old_bill(" + bi.ident + ")\">Edit</td></tr>";
    for (index = 1; index < c.length; index++) {
       ch = c[index];
       new_contents += "<tr><td colspan=2 />" + show_charge(ch) + "</tr>";
    }
  }
  new_contents += "</table>";
  $("#old_bills").html(new_contents);
}

function get_old_bills() {
  jQuery.getJSON("action/old_bills", {},
                 function(data) {
		   if (data.result == "okay") {
	             old_bills = data.data;
		     refresh_old_bills();
		   } else {
		     $("#old_bills").text("Error fetching old bills: " + data.error);
		   }
                 }, "json");
}
get_old_bills();

function edit_old_bill(ident) {
    var items = $("*[id^='old_bill_" + ident +"']");
    for (index = 0; index < items.length; index++) {
	item = items[index];
	cl = item.getAttribute("class");
	id = item.getAttribute("id");
	val = item.innerHTML;
	if (cl == "old_bill_date") {
	    item.innerHTML = "<input class=\"date-pick\" id=\"" + id + "_edit\" + value=\"" + val + "\">";
	    $('#' + id + "_edit").datePicker({startDate: '01/01/1996'});
	} else if (cl == "old_bill_description") {
	    item.innerHTML = "<input id=\"" + id + "_edit\" + value=\"" + val + "\">";
	} else if (cl == "old_bill_fullname") {
	    content = "<select>";
	    for (k in known_users) {
		
	    }
	}
    }
}
-->
</script>
</html>
